<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <h1 class="visually-hidden">Formulario de factura</h1>

  <!-- Datos cliente -->
  <fieldset class="invoice-form__section">
    <legend class="invoice-form__section-title">Cliente</legend>
    <label for="customer" class="invoice-form__label">Nombre del cliente</label>
    <input 
      id="customer"
      formControlName="customer" 
      placeholder="Nombre cliente"
      aria-describedby="customer-error"
      required>
    <div id="customer-error" *ngIf="form.get('customer')?.invalid && form.get('customer')?.touched" class="error" role="alert">
      Cliente requerido
    </div>
  </fieldset>

  <!-- Teléfonos -->
  <fieldset class="invoice-form__section">
    <legend class="invoice-form__section-title">Teléfonos</legend>
    <div formArrayName="phones" role="group" aria-label="Teléfonos de contacto">
      <div *ngFor="let phoneGroup of phones.controls; trackBy: trackByIndex; let i = index" [formGroupName]="i" class="invoice-form__item">
        <label [for]="'phone-' + i" class="invoice-form__label">Teléfono {{ i + 1 }}</label>
        <input 
          [id]="'phone-' + i"
          formControlName="phone" 
          placeholder="Teléfono (6xxxxxxxx)"
          type="tel"
          aria-describedby="'phone-' + i + '-error'">
        <button 
          type="button" 
          (click)="removePhone(i)" 
          *ngIf="phones.length > 1"
          class="invoice-form__remove-btn"
          [attr.aria-label]="'Eliminar teléfono ' + (i + 1)">
          Eliminar
        </button>
        <div [id]="'phone-' + i + '-error'" *ngIf="isPhoneInvalid(i)" class="error" role="alert">
          Teléfono inválido
        </div>
      </div>
      <button 
        type="button" 
        (click)="addPhone()"
        class="invoice-form__add-btn"
        aria-label="Añadir nuevo teléfono">
        Añadir teléfono
      </button>
    </div>
  </fieldset>

  <!-- Direcciones -->
  <fieldset class="invoice-form__section">
    <legend class="invoice-form__section-title">Direcciones</legend>
    <div formArrayName="addresses" role="group" aria-label="Direcciones de envío">
      <div *ngFor="let addressGroup of addresses.controls; trackBy: trackByIndex; let i = index" [formGroupName]="i" class="invoice-form__address">
        <label [for]="'street-' + i" class="invoice-form__label">Calle</label>
        <input 
          [id]="'street-' + i"
          formControlName="street" 
          placeholder="Calle"
          aria-describedby="'address-' + i + '-error'">
        
        <label [for]="'city-' + i" class="invoice-form__label">Ciudad</label>
        <input 
          [id]="'city-' + i"
          formControlName="city" 
          placeholder="Ciudad"
          aria-describedby="'address-' + i + '-error'">
        
        <label [for]="'zip-' + i" class="invoice-form__label">Código Postal</label>
        <input 
          [id]="'zip-' + i"
          formControlName="zip" 
          placeholder="CP"
          aria-describedby="'address-' + i + '-error'">
        
        <button 
          type="button" 
          (click)="removeAddress(i)" 
          *ngIf="addresses.length > 1"
          class="invoice-form__remove-btn"
          [attr.aria-label]="'Eliminar dirección ' + (i + 1)">
          Eliminar
        </button>

        <div [id]="'address-' + i + '-error'" *ngIf="isAddressInvalid(i)" class="error" role="alert">
          Todos los campos de la dirección son obligatorios y el CP debe tener 5 dígitos.
        </div>
      </div>
      <button 
        type="button" 
        (click)="addAddress()"
        class="invoice-form__add-btn"
        aria-label="Añadir nueva dirección">
        Añadir dirección
      </button>
    </div>
  </fieldset>

  <!-- Items de factura -->
  <fieldset class="invoice-form__section">
    <legend class="invoice-form__section-title">Items de factura</legend>
    <div formArrayName="items" role="group" aria-label="Items de la factura">
      <table class="invoice-form__items-table">
        <thead>
          <tr>
            <th scope="col">Descripción</th>
            <th scope="col">Cantidad</th>
            <th scope="col">Precio</th>
            <th scope="col">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let itemGroup of items.controls; trackBy: trackByIndex; let i = index" [formGroupName]="i" class="invoice-form__item-row">
            <td>
              <label [for]="'description-' + i" class="visually-hidden">Descripción del item</label>
              <input 
                [id]="'description-' + i"
                formControlName="description" 
                placeholder="Descripción"
                aria-describedby="'item-' + i + '-error'">
            </td>
            <td>
              <label [for]="'quantity-' + i" class="visually-hidden">Cantidad</label>
              <input 
                [id]="'quantity-' + i"
                formControlName="quantity" 
                type="number" 
                min="1"
                aria-describedby="'item-' + i + '-error'">
            </td>
            <td>
              <label [for]="'price-' + i" class="visually-hidden">Precio</label>
              <input 
                [id]="'price-' + i"
                formControlName="price" 
                type="number" 
                min="0" 
                step="0.01"
                aria-describedby="'item-' + i + '-error'">
            </td>
            <td>
              <button 
                type="button" 
                (click)="removeItem(i)" 
                *ngIf="items.length > 1"
                class="invoice-form__remove-btn"
                [attr.aria-label]="'Eliminar item ' + (i + 1)">
                Eliminar
              </button>
            </td>
            <td>
              <div [id]="'item-' + i + '-error'" *ngIf="isItemInvalid(i)" class="error" role="alert">
                Cantidad mínima 1 y precio ≥ 0.
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <button 
        type="button" 
        (click)="addItem()"
        class="invoice-form__add-btn"
        aria-label="Añadir nuevo item">
        Añadir item
      </button>
    </div>
  </fieldset>

  <section class="invoice-form__summary" aria-label="Resumen de la factura">
    <h2>Total: <output class="invoice-form__total">{{ getTotal() | currency:'EUR':'symbol' }}</output></h2>
  </section>

  <button 
    type="submit" 
    class="invoice-form__submit-btn"
    [disabled]="form.invalid || form.pending"
    aria-busy="form.pending">
    {{ form.pending ? 'Validando...' : 'Guardar factura' }}
  </button>
</form>
